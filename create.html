<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Create Page</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">
        <hr>
            <small class="text-muted d-block">@@@ Don't forget to press Update button. @@@</small>
            <small class="text-muted d-block">@@@ If you won't press update button maybe your data will missing @@@</small>
            <small class="text-muted d-block">@@@ Get some bug or Need for Info contact <span><a href="#">afumagic3@gmail.com</a></span> @@@</small>
        <hr>
        <div class="row mt-4">
            <div class="col-4 col-sm-4">
                <label class="text-center d-block bg-secondary text-white py-1 rounded">Node</label>
                <small class="form-text text-muted">Every node is many to many.</small>
                <small class="form-text text-muted">Example input data : project1</small>
            </div>
            <div class="col-8 col-sm-6">
                <label class="text-center d-block bg-secondary text-white py-1 rounded">Link</label>
                <small class="form-text text-muted">Every link you created is node.</small>
                <small class="form-text text-muted">Example input data : project1,project2,project3</small>
            </div>
        </div>
    </div>
    <form id="myForm" class="container my-3">
        <a class="bg-success d-block text-center rounded mt-4" id="newNodeButton" href="#" data-toggle="tooltip" data-placement="top" title="Add new node"><i class="fas fa-plus p-2" style="color:white; font-size: 14px;"></i></a>
        <button id="createButton" type="submit" class="btn btn-primary mt-5 d-block">Create Chart!</button>
    </form>

    <script>
        var node = []
        var member = 0

        function RemoveLink(id) {
            let num = id.substring(10);
            let nodeName = $('#nodeInput'+num).val() 
            $('#blockAppend'+num).remove()
            //clear node data and member
            for(let i=0;i<node.length;i++) {
                if(nodeName==node[i]) {
                    node[i] = ''
                    for(let j=i;j<node.length-1;j++) {
                        node[j] = node[j+1] 
                    }
                    node.pop()
                    console.log('now node is :', node)
                    member--
                    break
                }
            }
        }

        function AddLink(id) {
            //id => addLink?
            let num = id.substring(7);
            let nodeString = $('#nodeInput'+num).val()
            let linksString = $('#linksInput'+num).val()
            let links = linksString.split(",");

            console.log(nodeString)
            if(IsUniqueNode(nodeString) && nodeString!='') {
                console.log('push self')
                node.push(nodeString)
            }

            if(!IsLinkSameOwnNode(nodeString, links)) {
                CreateNewNodeFromLinks(links)
            }else {
                alert('Your Node and Link is same name!!!')
            }
            
            console.log('now node is :', node)
            console.log('now member is :', member)
        }

        function CreateNewNodeFromLinks(links) {
            for(let i=1;i<links.length;i++) {
                for(let j=0;j<i;j++) {
                    if(links[i]==links[j]) {
                        console.log('is same')
                        alert('Error can not input same links!!!')
                        return
                    }
                }
            }
            for(let i=0;i<links.length;i++) {
                if(IsUniqueNode(links[i]) && links[i]!=='') {
                    AppendNewNode(links[i], '')
                    node.push(links[i])
                }
            }
        }


        function IsLinkSameOwnNode(node, links) {
            for(let i=0;i<links.length;i++) {
                if(node == links[i]) {
                    return true
                }
            }
            return false
        }

        function IsUniqueNode(name) {
            for(let i=0;i<node.length;i++) {
                if(name==node[i]) {
                    console.log('same btw :',name,node[i])
                    return false
                }
            }
            console.log('ttt')
            return true
        }

        function AppendNewNode(val1, val2) {
            let appendString = 
                '<div id="blockAppend'+member+'" class="row justify-content-md-center">'
                    +'<div class="col-4 col-sm-4 mt-2">'
                        +'<div class="row">'
                            +'<div class="col">'
                                +'<input value="'+val1+'" type="text" class="form-control nn" id="nodeInput'+member+'" placeholder="Enter node name">'
                            +'</div>'
                        +'</div>'
                        +'<div class="row">'
                            +'<div class="col mt-2">'
                                +'<img height="90" width="160" src="http://www.jeffreythompson.org/images/blank-email-pixels.jpg" alt="">'
                            +'</div>'
                        +'</div>'
                    +'</div>'
                    +'<div class="col-8 col-sm-6 mt-2">'
                        +'<textarea class="form-control ll" rows="5" id="linksInput'+member+'">'+val2+'</textarea>'
                    +'</div>'
                    +'<div class="col-sm-2">'
                        +'<div class="row mt-2">'
                            +'<div class="col">'
                                +'<button onclick="AddLink(this.id);" id="addLink'+member+'"type="submit" class="btnAddLink btn btn-success btn-block">Update</button>'
                            +'</div>'
                        +'</div>'
                        +'<div class="row mt-2">'
                            +'<div class="col">'
                                +'<button onclick="AddImage(this.id);" id="addImage'+member+'"type="submit" class="btnAddImage btn btn-warning btn-block">Add Image</button>'
                            +'</div>'
                        +'</div>'
                        +'<div class="row mt-2">'
                            +'<div class="col">'
                                +'<button onclick="RemoveLink(this.id);" id="removeLink'+member+'"type="submit" class="btnRemoveLink btn btn-danger btn-block">Remove</button>'
                            +'</div>'
                        +'</div>'
                    +'</div>'
                +'</div>'
                +'<hr>'

            $(appendString).insertBefore('#newNodeButton')
            member++
        }

        function CheckFormat() {
            let nodes = $('.nn')
            let links = $('.ll')
            console.log('nodes :', nodes.length)
            
            if(member==0) {
                return false
            }

            for(let i=1;i<nodes.length;i++) {
                for(let j=0;j<i;j++) {
                    let n1 = $('#'+nodes[i].id).val() 
                    let n2 = $('#'+nodes[j].id).val()
                    if(n1==n2) {
                        console.log('Error can not input same links!!!')
                        //alert('Error can not input same links!!!')
                        return false
                    }
                }
            }

            for(let i=0;i<links.length;i++) {
                let string = $('#'+links[i].id).val()
                let linksArray = string.split(',') 
                for(let j=1;j<linksArray.length;j++) {
                    for(let k=0;k<j;k++) {
                        if(linksArray[j]==linksArray[k]) {
                            console.log('same inside links')
                            return false                        
                        }
                    } 
                }
            }

            for(let i=0;i<links.length;i++) {
                let nodeString = $('#'+nodes[i].id).val()
                let string = $('#'+links[i].id).val()
                let linksArray = string.split(',') 
                for(let i=0;i<linksArray.length;i++) {
                    if(linksArray[i] == nodeString) {
                        console.log('links same own node')
                        return false
                    }
                }
            }

            for(let i=0;i<nodes.length;i++) {
                let n = $('#'+nodes[i].id).val()
                if(n==='') {
                    console.log('is emply field')
                    return false
                }
            }

            console.log('links :', links)
            return true
        }



        function MakeJsonData() {
            let data = []
            for(let i=0;i<member;i++) {
                let obj = {}
                let nodeName = $('#nodeInput'+i).val()
                let linksString = $('#linksInput'+i).val()
                //console.log(linksString)
                //console.log(nodeName)
                let links = linksString.split(",")
                if(links.length==1 && links[0]=='') {
                    links = []
                }
                obj = {
                    name: nodeName,
                    imports: links
                }
                data.push(obj)
            }
            console.log('data is : ', data)
            console.log('jsonString data is : ', JSON.stringify(data))
        }

        $(document).ready(function() {
            
            $('#newNodeButton').on('click', function() {
                AppendNewNode('', '')
            })

            $('#createButton').on('click', function() {
                if(CheckFormat()) {
                    MakeJsonData()
                    alert('Chart is created Success')
                }else {
                    alert('Can not crate, Watch your data and rewrite!')
                }
            })

            
        })

    </script>
</body>
</html>